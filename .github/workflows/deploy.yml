name: Deploy to Server

on:
  workflow_run:
    workflows:
      - Build and Push Docker image to Docker Hub
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          envs: DOCKERHUB_USERNAME,DOCKERHUB_TOKEN
          script: |
            set -euo pipefail
            IMAGE="${DOCKERHUB_USERNAME}/onani-memo-chan:latest"
            docker login -u "${DOCKERHUB_USERNAME}" -p "${DOCKERHUB_TOKEN}"
            docker pull "${IMAGE}"
            docker stop onani-memo-chan || true
            docker rm onani-memo-chan || true
            docker run -d --name onani-memo-chan --restart unless-stopped \
              -v /opt/onani_memo_chan/data:/app/data \
              "${IMAGE}"
